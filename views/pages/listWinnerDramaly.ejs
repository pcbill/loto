
<!DOCTYPE html>
<html>
<head>
  <%- include('../partials/header.ejs') %>
</head>

<body>
  <%- include('../partials/nav.ejs') %>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      <h3>

      <% if (results && results.length > 0) { %>
             <%= results[0].awardList %> 共 <%= results.length %> 個
      <% } %>
      </h3>

      <% if (results && results.length > 0) { %>
      <table  class="table table-bordered table-hover">
        <thead>
                <tr>
                  <th></th>
                  <th>號碼</th>
                  <th>姓名</th>
                  <th>桌次</th>
                </tr>
        </thead>
        <tbody id="content" style="font-size:80px" />
      </table>
      <% } %>

      <div id="drawingStatus" style="display:none; font-size:24px; color:green; margin-top:20px;">
        ✓ 開獎結果已儲存
      </div>

    </div>
  </div>
</div>

<script>
<% if (results && results.length > 0) { %>
    var rowLength = <%= results.length %>;
    var count = 0;
    var content = <%- JSON.stringify(results) %>;
    var isDrawing = <%= typeof isDrawing !== 'undefined' && isDrawing ? 'true' : 'false' %>;
    var showAnimation = <%= typeof showAnimation !== 'undefined' && showAnimation ? 'true' : 'false' %>;
    var gid = '<%= gid %>';

    function showOne() {
        $('#content').prepend(
                      '<tr><td>'+ (count+1)  +'</td>'+
                          '<td>'+ content[count].uid +'</td>'+
                          '<td>'+ content[count].name +'</td>'+
                          '<td>'+ content[count].table_num +'</td></tr>'
        );
        count++;
        
        // 當所有中獎者都顯示完畢
        if (count >= rowLength) {
            clearInterval(intervalId);
            
            // 如果是開獎中狀態，呼叫 API 完成開獎
            if (isDrawing) {
                $.post('/completeNormalDrawing/' + gid, function(data) {
                    if (data.success) {
                        $('#drawingStatus').show();
                        console.log('開獎結果已儲存');
                    }
                }).fail(function(err) {
                    console.error('儲存開獎結果失敗', err);
                    alert('儲存開獎結果失敗，請聯繫管理員');
                });
            }
        }
    }
    
    function showAll() {
        // 直接顯示所有結果，不需動畫
        for (var i = 0; i < rowLength; i++) {
            $('#content').append(
                '<tr><td>'+ (i+1)  +'</td>'+
                    '<td>'+ content[i].uid +'</td>'+
                    '<td>'+ content[i].name +'</td>'+
                    '<td>'+ content[i].table_num +'</td></tr>'
            );
        }
    }

    var intervalId;
    if (showAnimation) {
        // 開獎主持人頁面：播放動畫
        intervalId = setInterval(showOne, 2000);
    } else {
        // 觀眾頁面：直接顯示所有結果
        showAll();
    }
<% } %>
</script>